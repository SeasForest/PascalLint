# PascalLint 技术路线与架构方案 (v0.3 - 验证版)

## 1. 项目概况

**PascalLint** 是一款现代化的 Delphi/Object Pascal 静态分析工具。它采用类似 ESLint 的架构，基于 **Tree-sitter** 进行增量解析，通过 **VSCode 扩展** 提供实时反馈和快速修复。

**核心价值**：
* 🚀 **实时反馈**：基于 WASM 的毫秒级增量解析。
* 🔧 **零依赖**：无需安装 Delphi IDE 或第三方编译器即可运行。
* 🛠️ **可扩展**：纯 TypeScript 编写的规则引擎，易于编写自定义规则。
* ✨ **自动修复**：支持 Code Actions，一键修复代码问题。

---

## 2. 验证架构 (已落地)

本项目采用 **Core + Adapter** 分层架构，目前已在 v0.1 中验证通过。

```mermaid
graph TD
    User[用户代码] --> Extension[VSCode Extension]
    Extension --> Parser[Tree-sitter Parser (WASM)]
    Extension --> Linter[Linter Engine]
    Linter --> Rules[Rule Collection]
    
    Parser -->|AST| Linter
    Linter -->|Issues| Extension
    Extension -->|Diagnostics| VSCode[VSCode UI]
    Extension -->|Code Actions| VSCode
```

### 关键技术栈
* **Parser**: `tree-sitter-pascal` (WASM) - **[已验证]** 解析速度极快，支持 Delphi 语法。
* **Engine**: TypeScript - **[已验证]** 规则编写简单，运行在 VSCode 扩展主机中。
* **Fixer**: Code Action Provider - **[已验证]** 支持 AST 节点替换。

---

## 3. 开发演进路线

### ✅ 第一阶段：核心骨架 (v0.1 - 已完成)
目标：跑通全流程，验证技术可行性。
- [x] Tree-sitter WASM 编译与集成
- [x] Linter 核心引擎 (AST 遍历、规则调度)
- [x] VSCode 诊断输出 (波浪线提示)
- [x] 配置文件支持 (.PascalLint.json)
- [x] 快速修复框架 (Quick Fix)
- [x] 示例规则：`no-with` (含自动修复建议), `empty-begin-end` (含自动删除)

### 🚀 第二阶段：规则扩充与体验 (v0.2 - 进行中)
目标：提供实用的规则集，无需配置即可提升代码质量。

#### 1. 规则库扩充 (目标 20+ 条)
* **代码风格 (Style)**:
  * `pascal-case`: 类名/方法名命名规范
  * `one-var-per-line`: 变量声明规范
  * `no-semicolon-before-else`: `else` 前的分号检测
* **最佳实践 (Best Practices)**:
  * `check-assigned`: 对象使用前检查 (简单 heuristic)
  * `use-free-and-nil`: 建议使用 `FreeAndNil`
  * `no-empty-finally`: 空 `finally` 块检测
* **潜在风险 (Safety)**:
  * `constructor-call-on-instance`: 错误地在实例上调用构造函数

#### 2. 体验优化
* [ ] **忽略文件支持**: `.PascalLintignore`
* [ ] **CLI 工具**: 独立 `PascalLint` 命令行工具 (用于 CI/CD)
* [ ] **SonarQube 兼容**: 支持输出 Sonar 兼容的报告格式 (`generic issue import format`)，规则集对齐。
* [ ] **规则文档**: 悬停提示中显示规则详细说明链接

### 🔬 第三阶段：深度分析 (v0.3 - 规划中)
目标：引入符号表，支持跨作用域分析。

* [ ] **符号表 (Symbol Table)**: 解析单元接口 (`interface`)，建立类型索引。
* [ ] **作用域分析**: 识别变量定义与引用，检测未使用变量 (`unused-variable`)。
* [ ] **基础类型推断**: 推断简单的表达式类型。

### 🌐 第四阶段：生态集成 (v1.0)
目标：成为 Delphi 社区的标准工具。

* [ ] **Language Server Protocol (LSP)**: 将 Linter 封装为标准 LS，支持 Neovim, Sublime。
* [ ] **Web Playground**: 在浏览器中直接体验 Lint。
* [ ] **Plugin System**: 支持加载第三方规则包 (npm)。

---

## 4. 目录结构规范

```text
e:\Github\PSLint\
├── docs/                   # 详细技术主要文档
├── parsers/                # WASM 文件
├── src/
│   ├── parser/             # AST 解析层
│   ├── linter/             # 核心逻辑
│   ├── rules/              # 规则定义 (每条规则一个文件)
│   ├── config/             # 配置加载
│   └── extension.ts        # VSCode 适配层
├── test/                   # 测试用例
└── .PascalLint.json        # 默认配置
```

## 5. 规则开发指南

开发一条新规则极其简单：

```typescript
// src/rules/exampleRule.ts
export const exampleRule: LintRule = {
    name: 'example-rule',
    defaultSeverity: 'warn',
    nodeTypes: ['some_node_type'], // 关注的 AST 节点
    
    visit(node, context) {
        if (/* 检查逻辑 */) {
            context.report({
                message: '发现问题',
                fix: { /* 可选的修复逻辑 */ }
            });
        }
    }
};
```

## 6. 详细与规范文档

详细的实施细则请参考 `docs/` 目录下的文档：

*   **插件开发**: [VSCode 插件开发说明](docs/01-vscode-extension-development.md)
*   **核心实现**: [pslint 实现技术细节](docs/02-pslint-implementation.md)
*   **规则定义**: [规则集 (Rule Set)](docs/03-rule-set.md)
*   **修复机制**: [自动修复方法](docs/04-auto-fix-strategy.md)
*   **贡献指南**: [代码编写与贡献规范](docs/05-contribution-guide.md)
*   **发布运维**: [版本维护与插件上架](docs/06-versioning-and-publishing.md)

